# Data Model: Book RAG Chatbot

## Entity Models

### Book Content
**Description**: Represents the ingested book content from the sitemap.xml
- **Fields**:
  - `id` (string): Unique identifier for the content chunk
  - `url` (string): Original URL from the sitemap where content was found
  - `title` (string): Title of the content section
  - `content` (string): The actual text content of the chunk
  - `embedding` (list[float]): Vector embedding of the content
  - `metadata` (dict): Additional metadata including source, date, etc.
  - `created_at` (datetime): Timestamp when content was ingested
  - `updated_at` (datetime): Timestamp when content was last updated

**Relationships**: None directly, but related through semantic similarity in vector space

### User Query
**Description**: Represents a user's question or request to the system
- **Fields**:
  - `id` (string): Unique identifier for the query
  - `text` (string): The natural language question from the user
  - `selected_chunks` (list[string]): Optional list of specific chunk IDs to restrict search to
  - `timestamp` (datetime): When the query was submitted
  - `session_id` (string): Optional session identifier for conversation context

### Retrieved Passages
**Description**: Relevant text segments retrieved from the vector database based on semantic similarity
- **Fields**:
  - `chunk_id` (string): Identifier of the retrieved content chunk
  - `document_id` (string): Identifier of the source document
  - `content` (string): The actual text content of the retrieved passage
  - `similarity_score` (float): Similarity score from vector search (0.0-1.0)
  - `source_url` (string): URL where the content originated
  - `metadata` (dict): Additional metadata about the source

### Response
**Description**: The structured output containing both JSON schema and human-readable answer with citations
- **Fields**:
  - `id` (string): Unique identifier for the response
  - `query_id` (string): Reference to the original user query
  - `answer` (string): The main answer text generated by the system
  - `evidence` (list[dict]): List of evidence objects containing source citations
  - `confidence` (string): Confidence level ("High", "Medium", or "Low")
  - `follow_up` (dict): Optional follow-up question suggestion
  - `timestamp` (datetime): When the response was generated
  - `json_schema` (dict): The complete response in the required JSON format

### Evidence
**Description**: Source citation included in responses to verify information
- **Fields**:
  - `doc_id` (string): Document identifier where the information was found
  - `chunk_id` (string): Chunk identifier within the document
  - `quote` (string): Verbatim quote or relevant excerpt (≤200 characters)
  - `source_url` (string): URL of the source document

### Chunk ID
**Description**: Unique identifiers for specific segments of book content in the database
- **Fields**:
  - `id` (string): The unique chunk identifier
  - `document_id` (string): Reference to the parent document
  - `sequence_number` (int): Order of the chunk within the document
  - `hash` (string): Content hash for integrity verification

## Validation Rules

### Book Content Validation
- Content must be non-empty
- Embedding must be a valid vector (1536-dimensional for OpenAI ada-002)
- URL must be a valid URL format
- Metadata must include source information

### User Query Validation
- Query text must be non-empty
- Selected chunks must exist in the database if provided
- Query length should be reasonable (e.g., <1000 characters)

### Response Validation
- Answer must be based only on retrieved passages
- Evidence list must be populated when answer is provided
- Confidence level must be one of "High", "Medium", or "Low"
- Follow-up question must be relevant to the original query

### Evidence Validation
- Document ID must reference an existing document
- Chunk ID must reference an existing chunk
- Quote must be ≤200 characters
- Quote must be an exact or verbatim excerpt from the source

## State Transitions

### Content Ingestion Flow
1. **Pending**: Content URL discovered from sitemap
2. **Processing**: Content is being fetched and embedded
3. **Indexed**: Content is stored in Qdrant with embedding
4. **Available**: Content is ready for retrieval

### Query Processing Flow
1. **Received**: User query is submitted
2. **Interpreted**: Query is parsed and understood
3. **Retrieved**: Relevant passages are found in vector database
4. **Generated**: Answer is created from retrieved passages
5. **Responded**: Response is returned to user

## API Contracts

### Query Endpoint
- **Path**: `/api/v1/query`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "query": "string",
    "selected_chunks": ["string"]  // Optional
  }
  ```
- **Response**:
  ```json
  {
    "answer": "string",
    "evidence": [
      {
        "doc_id": "string",
        "chunk_id": "string",
        "quote": "string"
      }
    ],
    "confidence": "High|Medium|Low",
    "follow_up": {
      "ask": true|false,
      "question": "string"
    }
  }
  ```

### Ingestion Endpoint
- **Path**: `/api/v1/ingest`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "sitemap_url": "string",
    "book_title": "string"
  }
  ```
- **Response**: Status of ingestion process